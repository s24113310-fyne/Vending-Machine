<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Elegant Jewelry Vending Machine ✨</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap');
  body {
    font-family: 'Montserrat', sans-serif;
    margin: 0;
    padding: 40px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: #5a1a7e;
    background: linear-gradient(135deg, #f8d7e3, #f9e8ef);
    overflow: hidden;
    position: relative;
  }
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image:
      radial-gradient(2px 2px at 10% 20%, rgba(255 255 255 / 0.8), transparent 60%),
      radial-gradient(1.5px 1.5px at 25% 40%, rgba(255 255 255 / 0.6), transparent 60%),
      radial-gradient(2px 2px at 50% 10%, rgba(255 255 255 / 0.7), transparent 60%),
      radial-gradient(1.8px 1.8px at 70% 80%, rgba(255 255 255 / 0.5), transparent 60%),
      radial-gradient(1.5px 1.5px at 85% 30%, rgba(255 255 255 / 0.6), transparent 60%);
    background-repeat: repeat;
    background-size: 200px 200px;
    animation: glitterMove 15s linear infinite;
    z-index: 0;
    pointer-events: none;
  }
  @keyframes glitterMove { 0% { background-position: 0 0; } 100% { background-position: 200px 200px; } }

  .container {
    display: flex;
    background: #fff0fc;
    border-radius: 30px;
    box-shadow: 0 20px 40px rgba(135, 20, 105, 0.3);
    max-width: 1100px;
    width: 100%;
    padding: 24px 30px;
    color: #5a1a7e;
    position: relative;
    z-index: 1;
  }

  /* machine exterior styling to make it look like a standing vending machine */
  .machine { display:flex; flex-direction:column; align-items:center; gap:12px; }
  .machine-top {
    width: 360px; background: linear-gradient(180deg,#2b0b3a,#3d1458); border-radius: 10px; padding: 8px 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.22);
    display:flex; flex-direction:column; align-items:center; justify-content:center; color: #fff; text-align:center;
  }
  .machine-title { font-weight: 900; letter-spacing: 5px; font-size: 1.05rem; display:flex; gap:6px; align-items:center; justify-content:center; }
  .machine-title span { padding: 4px 6px; border-radius:4px; background: rgba(255,255,255,0.06); box-shadow: 0 2px 8px rgba(0,0,0,0.2) inset; }
  .machine-bulbs { margin-top:8px; display:flex; gap:6px; }
  .machine-bulbs .bulb { width:10px; height:10px; border-radius:50%; background:#ffef8a; box-shadow: 0 0 6px rgba(255,239,138,0.8); animation: bulbPulse 1.6s infinite ease-in-out; }
  .machine-bulbs .bulb:nth-child(2n) { background:#ffd1d1; box-shadow: 0 0 6px rgba(255,209,209,0.7); animation-delay:0.12s }
  .machine-bulbs .bulb:nth-child(3n) { background:#b6f0ff; box-shadow: 0 0 6px rgba(91,212,255,0.6); animation-delay:0.24s }
  @keyframes bulbPulse { 0%{transform:scale(0.9);opacity:0.9}50%{transform:scale(1.2);opacity:1}100%{transform:scale(0.9);opacity:0.9} }

  .machine-body .container { max-width: 420px; width: 420px; padding: 18px; border-radius: 12px; box-shadow: 0 12px 30px rgba(10,10,20,0.12); }
  /* side panels to emulate vending machine sides */
  .machine-body { position: relative; display:flex; align-items:flex-start; }
  .machine-body::before, .machine-body::after { content: ''; position: absolute; top: 6px; width: 24px; height: calc(100% - 12px); background: linear-gradient(180deg,#1f0a28,#2b0b3a); border-radius: 6px; box-shadow: inset 0 8px 14px rgba(0,0,0,0.18); }
  .machine-body::before { left: -34px; }
  .machine-body::after { right: -34px; }
  .machine-base { width: 420px; display:flex; justify-content:space-between; margin-top: -4px; }
  .machine-base .leg { width: 30px; height: 18px; background: linear-gradient(180deg,#2b0b3a,#1f0a28); border-radius: 6px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }

  h1 {
    font-size: 3rem;
    margin-bottom: 40px;
    font-weight: 900;
    letter-spacing: 3px;
    color: #8e2ad6;
    text-shadow: 0 3px 10px rgba(142, 42, 214, 0.5);
    position: relative;
  }

  h1::after {
    content: "💎✨";
    margin-left: 12px;
    animation: sparkle 2s ease-in-out infinite alternate;
  }
  @keyframes sparkle { 0% { opacity: 0.4; transform: scale(1); } 100% { opacity: 1; transform: scale(1.4) rotate(5deg); } }

  .vending-machine { flex: 1; text-align: center; }
  .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 40px; }

  .item-card {
    background: #fff4fc;
    border-radius: 20px;
    padding: 20px 15px 30px;
    box-shadow: 0 8px 15px rgba(142, 42, 214, 0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .item-card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 20px 40px rgba(142, 42, 214, 0.5); border: 2px solid #8e2ad6; }

  .item-emoji { font-size: 3rem; margin-bottom: 10px; }
  .item-name { font-weight: 700; font-size: 1.2rem; color: #6a1b9a; margin-bottom: 10px; }
  .item-price {
    font-weight: 800; font-size: 1.2rem;
    background: linear-gradient(90deg, #d15eff, #8e2ad6);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 15px;
  }
  .buy-btn {
    background: linear-gradient(45deg, #8e2ad6, #5a1a7e);
    color: white; border: none; border-radius: 18px;
    padding: 10px 20px; font-weight: 800;
    box-shadow: 0 6px 15px rgba(142, 42, 214, 0.5);
    cursor: pointer; transition: transform 0.2s ease;
  }
  .buy-btn:hover { transform: scale(1.1); }

  .balance { font-size: 1.8rem; font-weight: 900; color: #7a1fa2; margin-bottom: 10px; }
  .message { min-height: 32px; font-weight: 700; font-size: 1.2rem; margin-bottom: 25px; color: #aa33cc; }

  .keypad {
    width: 250px; background: #f5e1f7;
    border-radius: 30px; box-shadow: 0 15px 40px rgba(135, 20, 105, 0.25);
    padding: 30px 20px; margin-left: 40px;
    display: flex; flex-direction: column; align-items: center;
  }
  /* Coins + slot styles */
  .coins-container {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }
  .coin {
    width: 54px; height: 54px; border-radius: 50%;
    display: inline-flex; align-items: center; justify-content: center;
    color: white; font-weight: 900; cursor: grab; user-select: none;
    box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    border: 3px solid rgba(255,255,255,0.12);
    transition: transform 0.14s ease, box-shadow 0.14s ease;
  }
  .coin:active { cursor: grabbing; transform: scale(0.98); }
  .coin.small { width: 46px; height: 46px; font-size: 0.9rem; }

  .coin.slot-10 { background: linear-gradient(135deg,#ffd46a,#ffb84d); color:#512500 }
  .coin.slot-50 { background: linear-gradient(135deg,#ffd29a,#ff8c4f); }
  .coin.slot-100 { background: linear-gradient(135deg,#b6f0ff,#5bd4ff); color:#003b45 }
  .coin.slot-500 { background: linear-gradient(135deg,#e2c6ff,#c08eff); }
  .coin.slot-1000 { background: linear-gradient(135deg,#ffd6f0,#ff9adf); }

  .coin-slot {
    width: 140px; height: 44px; border-radius: 10px; background: linear-gradient(180deg,#f1dff3,#fbeefb);
    border: none; display:flex; align-items:center; justify-content:center; margin: 0 auto;
    color:#7a1fa2; font-weight:800; margin-bottom:18px; position: relative; overflow: visible;
    transition: box-shadow 0.12s ease, transform 0.12s ease, border-color 0.12s ease;
  }
  /* smaller centered label + thin slit to mimic a real coin mouth */
  .coin-slot::after {
    content: 'Insert Coin'; position:absolute; left:50%; top:50%; transform: translate(-50%, -50%);
    font-size:0.85rem; opacity:0.95; font-weight:700;
    white-space: nowrap;
  }
  .coin-slot::before {
    content: '';
    position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    width: 70%; height: 8px; background: rgba(0,0,0,0.12); border-radius: 6px; box-shadow: inset 0 -2px 6px rgba(0,0,0,0.06);
  }
  .coin-slot.active { box-shadow: 0 6px 18px rgba(138, 45, 170, 0.15); transform: translateY(-2px); border-color: rgba(142,42,214,0.45); }

  /* floating clone used for animation */
  .coin-clone { position: absolute; pointer-events: none; z-index: 20000; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
  /* release tray where purchased products appear */
  .release-area { width: 100%; margin-top: 6px; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .release-label { font-size: 0.85rem; color: #6a1b9a; font-weight:800; }
  .release-slot { width: 160px; height: 72px; background: linear-gradient(180deg,#fff,#f6f3ff); border-radius: 10px; box-shadow: inset 0 4px 8px rgba(0,0,0,0.06), 0 6px 18px rgba(142,42,214,0.06); display:flex; align-items:center; justify-content:center; position: relative; overflow: hidden; }
  .released-item { font-size: 2.2rem; transform: translateY(-60px) scale(0.6); opacity: 0; transition: transform 420ms cubic-bezier(.2,.9,.2,1), opacity 420ms; cursor: pointer; }
  .released-item.visible { transform: translateY(0) scale(1); opacity: 1; }
  /* keypad styles */
  .keypad-display { width: 160px; height: 44px; background: #fff; border-radius: 10px; display:flex; align-items:center; justify-content:flex-end; padding: 6px 12px; box-shadow: inset 0 -2px 6px rgba(0,0,0,0.04); font-weight:800; color:#7a1fa2; margin-bottom:10px; font-size:1.2rem; }
  .keypad-grid { display:grid; grid-template-columns: repeat(3, 46px); gap: 8px; justify-content:center; margin-bottom:10px; }
  .key-btn { width:46px; height:46px; border-radius:8px; border:none; background:linear-gradient(180deg,#f7e9ff,#f0d9ff); color:#5a1a7e; font-weight:800; cursor:pointer; box-shadow: 0 6px 14px rgba(142,42,214,0.08); }
  .key-btn.action { grid-column: span 3; background: linear-gradient(45deg,#8e2ad6,#5a1a7e); color: #fff; }

  /* change collection area */
  .change-area { width: 100%; margin-top: 10px; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .change-label { font-size: 0.85rem; color: #6a1b9a; font-weight:800; }
  .change-slot { width: 160px; min-height: 54px; background: linear-gradient(180deg,#fff,#f4fff9); border-radius: 10px; box-shadow: inset 0 4px 8px rgba(0,0,0,0.03), 0 6px 18px rgba(0,120,80,0.04); display:flex; align-items:center; justify-content:flex-start; gap:8px; padding:8px; flex-wrap:wrap; }
  .change-coin { width:36px; height:36px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; font-weight:800; color:#fff; box-shadow: 0 6px 10px rgba(0,0,0,0.07); cursor:pointer; }
  .insert-title { font-weight: 900; font-size: 1.3rem; margin-bottom: 20px; color: #7a1fa2; }
  .money-buttons {
    display: grid; grid-template-columns: repeat(2, 1fr);
    gap: 15px; width: 100%;
  }
  .money-btn {
    background: linear-gradient(45deg, #8e2ad6, #5a1a7e);
    color: white; border: none; border-radius: 20px;
    font-size: 1.2rem; font-weight: 900; padding: 15px 0;
    cursor: pointer; box-shadow: 0 8px 18px rgba(142, 42, 214, 0.6);
    transition: transform 0.2s ease;
  }
  .money-btn:hover { transform: scale(1.1); }

  .floating-item {
    position: absolute;
    font-size: 2.5rem;
    animation: floatUp 5s ease-in-out forwards;
    opacity: 0;
    z-index: 999;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
    100% { opacity: 0; transform: translateY(-300px) scale(1.5) rotate(360deg); }
  }

  /* smaller float animation used inside release-slot */
  .floating-item.release {
    font-size: 1.8rem;
    animation: floatUpSmall 1.6s cubic-bezier(.2,.9,.2,1) forwards;
    z-index: 5;
  }
  @keyframes floatUpSmall {
    0% { opacity: 1; transform: translateY(20px) scale(0.6) rotate(0deg); }
    100% { opacity: 0; transform: translateY(-8px) scale(1) rotate(20deg); }
  }

  /* Receipt popup */
  .receipt-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.35);
    z-index: 9998; display:flex; align-items:center; justify-content:center;
  }

  .receipt {
    position: fixed;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 22px 26px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.25), 0 10px 30px rgba(142, 42, 214, 0.12);
    color: #5a1a7e;
    font-weight: 600;
    animation: fadeIn 0.28s ease;
    z-index: 9999;
    max-width: 420px; width: 90%; text-align: left;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
  <div class="machine">
    <div class="machine-top">
      <div class="machine-title">
        <span>A</span><span>E</span><span>S</span><span>T</span><span>H</span><span>E</span><span>T</span><span>I</span><span>C</span>
        <span style="margin-left:8px">SIDE</span>
      </div>
      <div class="machine-bulbs" aria-hidden="true">
        <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
      </div>
    </div>
    <div class="machine-body">
      <div class="container">
        <div class="vending-machine">
      <h1>Jewelry Vending Machine</h1>
      <div class="items-grid" id="itemsGrid"></div>
      <div class="balance" id="balanceDisplay">Balance: NTD 0.00</div>
      <div class="message" id="message"></div>
    </div>

    <div class="keypad">
      <div class="insert-title">Insert Money 💰</div>
        <!-- visual coin slot + draggable coins -->
        <div class="coin-slot" id="coinSlot" aria-label="Coin slot" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)"></div>

        <div class="coins-container" id="coinsContainer" aria-hidden="false"></div>

        <!-- numeric keypad for product selection -->
        <div class="keypad-display" id="keypadDisplay"> </div>
        <div class="keypad-grid" id="keypadGrid">
          <button class="key-btn" onclick="pressKey('1')">1</button>
          <button class="key-btn" onclick="pressKey('2')">2</button>
          <button class="key-btn" onclick="pressKey('3')">3</button>
          <button class="key-btn" onclick="pressKey('4')">4</button>
          <button class="key-btn" onclick="pressKey('5')">5</button>
          <button class="key-btn" onclick="pressKey('6')">6</button>
          <button class="key-btn" onclick="pressKey('7')">7</button>
          <button class="key-btn" onclick="pressKey('8')">8</button>
          <button class="key-btn" onclick="pressKey('9')">9</button>
          <button class="key-btn" onclick="pressKey('0')">0</button>
          <button class="key-btn" onclick="backspaceKey()">⌫</button>
          <button class="key-btn action" onclick="buyByCode()">BUY</button>
        </div>

        <!-- product release tray: where purchased items appear for collection -->
        <div class="release-area" id="releaseArea">
          <div class="release-label">Collect your product ↓</div>
          <div class="release-slot" id="releaseSlot" aria-live="polite" aria-atomic="true"></div>
        </div>

        <!-- change collection area -->
        <div class="change-area" id="changeAreaContainer">
          <div class="change-label">Collect Change</div>
          <div class="change-slot" id="changeSlot"></div>
        </div>
    </div>
      </div>
    <div class="machine-base">
      <div class="leg"></div>
      <div class="leg"></div>
    </div>
  </div>

  <!-- Sound effects -->
  <audio id="coinSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c71de28a1d.mp3"></audio>
  <audio id="buySound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_5e19e9db5a.mp3"></audio>

<script>
  const items = [
    { name: 'Diamond Ring', price: 55, emoji: '💍' },
    { name: 'Gold Necklace', price: 80, emoji: '📿' },
    { name: 'Silver Bracelet', price: 45, emoji: '🧿' },
    { name: 'Pearl Earrings', price: 50, emoji: '👂' },
    { name: 'Emerald Anklet', price: 60, emoji: '🦶' },
    { name: 'Belly Accessory', price: 70, emoji: '💫' }
  ];

  let balance = 0;
  const balanceDisplay = document.getElementById('balanceDisplay');
  const message = document.getElementById('message');
  const itemsGrid = document.getElementById('itemsGrid');
  const coinSound = document.getElementById('coinSound');
  const buySound = document.getElementById('buySound');
  const releaseArea = document.getElementById('releaseArea');
  const releaseSlot = document.getElementById('releaseSlot');

  // drag-and-drop coin support
  const coinsContainerEl = document.getElementById('coinsContainer');
  const coinSlotEl = document.getElementById('coinSlot');
  const keypadDisplay = document.getElementById('keypadDisplay');
  const changeSlot = document.getElementById('changeSlot');

  function createCoinElements() {
    const denoms = [10,50,100,500,1000];
    coinsContainerEl.innerHTML = '';
    denoms.forEach(d => {
      const c = document.createElement('div');
      c.className = `coin slot-${d}`;
      c.draggable = true;
      c.setAttribute('role','button');
      c.setAttribute('aria-label', `NTD ${d}`);
      c.dataset.amount = d;
      c.textContent = d === 1000 ? '1k' : d;
      c.addEventListener('dragstart', handleDragStart);
      c.addEventListener('dragend', handleDragEnd);
      coinsContainerEl.appendChild(c);
    });
  }

  function handleDragStart(e) {
    const amount = e.target.dataset.amount || e.target.getAttribute('data-amount');
    e.dataTransfer.setData('text/plain', amount);
    // create a drag image so cursor shows coin
    const crt = e.target.cloneNode(true);
    crt.style.width = '54px'; crt.style.height = '54px';
    crt.style.transform = 'translate(-10px,-10px)';
    document.body.appendChild(crt);
    e.dataTransfer.setDragImage(crt, 27, 27);
    // remove created drag image after a short timeout (some browsers keep it)
    setTimeout(() => crt.remove(), 0);
  }

  function handleDragEnd(e) {
    // nothing for now
  }

  function handleDragOver(e) {
    e.preventDefault();
    coinSlotEl.classList.add('active');
  }

  function handleDragLeave(e) {
    coinSlotEl.classList.remove('active');
  }

  function handleDrop(e) {
    e.preventDefault();
    coinSlotEl.classList.remove('active');
    const amount = parseInt(e.dataTransfer.getData('text/plain'), 10);
    if (!isNaN(amount) && amount > 0) {
      // animate a cloned coin from drop point into the slot
      const clientX = e.clientX;
      const clientY = e.clientY;
      animateCoinToSlot(clientX, clientY, amount);
      // delay actual money insertion so animation is noticeable
      setTimeout(() => insertMoney(amount), 240);
    }
  }

  function animateCoinToSlot(startX, startY, amount) {
    const clone = document.createElement('div');
    clone.className = 'coin-clone coin slot-' + amount;
    clone.textContent = amount === 1000 ? '1k' : amount;
    clone.style.left = (startX - 28) + 'px';
    clone.style.top = (startY - 28) + 'px';
    clone.style.width = '54px'; clone.style.height = '54px';
    clone.style.fontSize = '1rem';
    clone.style.transition = 'transform 260ms ease, opacity 260ms ease, left 260ms ease, top 260ms ease';
    document.body.appendChild(clone);

    const slotRect = coinSlotEl.getBoundingClientRect();
    const targetX = slotRect.left + slotRect.width / 2 - 27;
    const targetY = slotRect.top + slotRect.height / 2 - 27;

    // force layout then move
    requestAnimationFrame(() => {
      clone.style.left = targetX + 'px';
      clone.style.top = targetY + 'px';
      clone.style.transform = 'scale(0.6) translateY(6px)';
      clone.style.opacity = '0.8';
    });

    setTimeout(() => {
      clone.style.opacity = '0';
      setTimeout(() => clone.remove(), 300);
    }, 300);
  }

  function animateCoinInsertAtCenter(element, amount) {
    const rect = element.getBoundingClientRect();
    animateCoinToSlot(rect.left + rect.width/2, rect.top + rect.height/2, amount);
  }

  // keypad functions for product selection
  let keypadValue = '';
  function pressKey(d) {
    if (keypadValue.length >= 2) return; // two digits max for product code
    keypadValue += d;
    renderKeypad();
  }
  function backspaceKey() {
    keypadValue = keypadValue.slice(0, -1);
    renderKeypad();
  }
  function renderKeypad() {
    keypadDisplay.textContent = keypadValue || ' ';
  }
  function buyByCode() {
    if (!keypadValue) { showMessage('Enter product number'); return; }
    const code = parseInt(keypadValue, 10);
    // product list is 1..items.length
    if (isNaN(code) || code < 1 || code > items.length) { showMessage('Invalid code'); keypadValue=''; renderKeypad(); return; }
    const idx = code - 1;
    keypadValue = '';
    renderKeypad();
    buyItem(idx);
  }

  // change creation and collection
  function createChange(change) {
    // break change into denominations
    const denoms = [1000,500,100,50,10];
    changeSlot.innerHTML = '';
    // ensure we only give whole NTD coins; floor to avoid giving extra
    let remaining = Math.floor(change);
    denoms.forEach(d => {
      while (remaining >= d) {
        remaining -= d;
        const el = document.createElement('div');
        el.className = 'change-coin slot-' + d;
        el.style.background = getComputedStyle(document.querySelector('.coin.slot-' + d)).background;
        el.textContent = d === 1000 ? '1k' : (d);
        el.dataset.amount = d;
        el.addEventListener('click', () => collectChangeCoin(el));
        changeSlot.appendChild(el);
      }
    });
    // if there is leftover less than smallest denomination, show as small text so user knows
    if (remaining > 0) {
      const txt = document.createElement('div');
      txt.textContent = `Remaining: NTD ${remaining.toFixed(0)}`;
      txt.style.color = '#2b8042'; txt.style.fontWeight = '700'; txt.style.fontSize = '0.9rem';
      changeSlot.appendChild(txt);
    }
  }

  function collectChangeCoin(el) {
    const amount = parseInt(el.dataset.amount || 0, 10);
    if (!amount) return;
    // simple collect animation then remove
    el.style.transform = 'scale(0.6)'; el.style.opacity = '0';
    setTimeout(() => {
      el.remove();
      showMessage(`Collected change: NTD ${amount}`);
    }, 220);
  }

  // release tray logic: show purchased item and allow collecting
  function releaseProduct(item) {
    // create a node inside releaseSlot
    const node = document.createElement('div');
    node.className = 'released-item';
    node.textContent = item.emoji;
    node.title = `Collect: ${item.name}`;
    // clicking collects the product
    node.addEventListener('click', () => collectProduct(node, item));
    // clear any previous item (simulate one-at-a-time collection)
    releaseSlot.innerHTML = '';
    releaseSlot.appendChild(node);

    // small delay then show (drop in)
    requestAnimationFrame(() => {
      node.classList.add('visible');
    });
  }

  function collectProduct(node, item) {
    // play sound to indicate collection
    playSound(buySound);
    // little pop animation then remove
    node.style.transition = 'transform 240ms ease, opacity 240ms ease';
    node.style.transform = 'translateY(-12px) scale(0.9)';
    node.style.opacity = '0';
    setTimeout(() => {
      node.remove();
      showMessage(`Collected: ${item.name} ${item.emoji}`);
    }, 260);
  }


  function playSound(sound) {
    sound.currentTime = 0;
    sound.play();
  }

  function renderItems() {
    itemsGrid.innerHTML = '';
    items.forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'item-card';
      card.innerHTML = `
        <div class="item-emoji">${item.emoji}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-price">NTD ${item.price.toFixed(2)}</div>
        <button class="buy-btn" onclick="buyItem(${index})">Buy</button>
      `;
      itemsGrid.appendChild(card);
    });
  }

  // initialize coins UI
  createCoinElements();
  renderKeypad();

  function insertMoney(amount) {
    playSound(coinSound);
    balance += amount;
    updateBalance();
    showMessage(`Inserted NTD ${amount}! 💰`);
  }

  function buyItem(index) {
    const item = items[index];
    if (balance < item.price) {
      showMessage('Insufficient balance!');
      return;
    }
    balance -= item.price;
    updateBalance();
    playSound(buySound);
    showMessage(`You bought: ${item.name} 💖`);
    // create a small floating shower inside the release slot area
    createFloatingShower(item.emoji, releaseSlot);

    // release product into the tray shortly after purchase
    setTimeout(() => releaseProduct(item), 700);

    // move remaining balance into change and empty machine balance
    const change = balance;
    if (change > 0) {
      createChange(change);
      balance = 0;
      updateBalance();
    } else {
      // clear change area if nothing to return
      changeSlot.innerHTML = '';
    }

    setTimeout(() => {
      const wantsReceipt = confirm('Would you like a receipt? 🧾');
      if (wantsReceipt) showReceipt(item);
      else showMessage('Thank you for your purchase! 💕');
    }, 1500);
  }

  function updateBalance() {
    balanceDisplay.textContent = `Balance: NTD ${balance.toFixed(2)}`;
  }

  function showMessage(msg) {
    message.textContent = msg;
    clearTimeout(showMessage.timeout);
    showMessage.timeout = setTimeout(() => message.textContent = '', 4000);
  }

  // Floating emojis. When containerEl is provided, float only inside that element.
  function createFloatingShower(emoji, containerEl = document.body) {
    // if the container is the releaseSlot, make a small, short shower
    const isRelease = containerEl === releaseSlot;
    const count = isRelease ? (6 + Math.floor(Math.random() * 4)) : (60 + Math.random() * 40);

    for (let i = 0; i < count; i++) {
      const el = document.createElement('div');
      el.className = 'floating-item' + (isRelease ? ' release' : '');
      el.textContent = emoji;

      if (isRelease) {
        // position relative to releaseSlot
        const rect = containerEl.getBoundingClientRect();
        const x = 12 + Math.random() * (rect.width - 24);
        const y = rect.height - 20 - Math.random() * 6; // start near bottom
        el.style.left = x + 'px';
        el.style.bottom = '6px';
        el.style.position = 'absolute';
        el.style.fontSize = (1.4 + Math.random() * 1.1) + 'rem';
        // small random delay so they don't animate all at once
        el.style.animationDelay = (Math.random() * 0.25) + 's';
        containerEl.appendChild(el);
        // remove after animation
        setTimeout(() => el.remove(), 2200 + Math.random() * 400);
      } else {
        // default full-page shower (legacy)
        el.style.left = Math.random() * window.innerWidth + 'px';
        el.style.bottom = Math.random() * 80 + 'px';
        el.style.fontSize = (2 + Math.random() * 2.5) + 'rem';
        el.style.animationDuration = (3 + Math.random() * 2) + 's';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 5500);
      }
    }
  }

  // Receipt pop-up
  function showReceipt(item) {
    // create a semi-transparent backdrop and centered receipt modal
    const backdrop = document.createElement('div');
    backdrop.className = 'receipt-backdrop';

    const receipt = document.createElement('div');
    receipt.className = 'receipt';
    const now = new Date();
    receipt.innerHTML = `
      <strong>🧾 Jewelry Vending Machine</strong><br><br>
      Item: ${item.name} ${item.emoji}<br>
      Price: NTD ${item.price.toFixed(2)}<br>
      Remaining Balance: NTD ${balance.toFixed(2)}<br><br>
      Time: ${now.toLocaleTimeString()}<br>
      Date: ${now.toLocaleDateString()}<br><br>
      💖 Thank you for your purchase!
    `;

    // append backdrop then receipt so the receipt is on top
    document.body.appendChild(backdrop);
    document.body.appendChild(receipt);

    // auto-remove both after a short delay
    setTimeout(() => {
      receipt.remove();
      backdrop.remove();
    }, 8000);
  }

  renderItems();
  updateBalance();
</script>
</body>
</html>
